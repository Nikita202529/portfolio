"use strict";var globalThis=void 0;!function(g){function L(t){return!isNaN(t)}function t(){var e=this;e.calculatorData=null;var t=document.getElementById("calculator"),f=t.querySelector("#calculator_row"),h=t.querySelector(".CalcTable .CalcBody"),a=t.querySelector(".CalcTable .CalcFooter .CalcRow"),m=t.querySelector(".result"),v=t.querySelector(".requestBtn"),p=0;function w(){var t=g(h).find('[data-dynamic-row="true"]'),e=g(t[0]).find(".close");1===t.length?e.attr("close-disabled","true"):e.attr("close-disabled","false")}function y(){for(var t=g(h).find('[data-dynamic-row="true"]'),e=[],a=0;a<t.length;a++){var r=t[a],i=g(r).find(".serviceList")[0],n=g(i).select3("value");Object.prototype.hasOwnProperty.call(data.services,n)&&e.push(n)}for(var o=0;o<t.length;o++)for(var d=t[o],s=g(d).find(".serviceList")[0],l=g(s).find('[select3-option="true"]'),c=0;c<l.length;c++){var u=l[c],f=g(u).attr("value");g(s).select3("showOpt",c),g(u).attr("checked")||-1!==e.indexOf(f)&&g(s).select3("hideOpt",c)}}function b(t){var e=g(h).find('[data-dynamic-row="true"]');if(!t)for(var a=0;a<e.length;a++){var r=e[a],i=g(r).find(".serviceList")[0],n=g(i).select3("value");if(g(m).removeClass("error"),t||""===n.trim())return g(m).addClass("error"),g(m).html("Заполните все поля"),void g(m).append(g("<div>",{class:"errorDescription",text:a===e.length-1?"В нижней строке не выбрана услуга":""}));var o=g(r).find(".amount")[0],d=g(o).val();if(g(m).removeClass("error"),t||""===d.trim())return g(m).addClass("error"),g(m).html("Заполните все поля"),void g(m).append(g("<div>",{class:"errorDescription",text:'В строке "'+n+'" не выбрано количество'}))}for(var s=0;s<e.length;s++){var l=e[s],c=g(l).find(".serviceList")[0],u=g(c).select3("value"),f=g(l).find(".amount")[0],v=g(f).val();if(g(m).removeClass("error"),!/^\d*$/.test(v)||""!==v.trim()&&parseInt(v,10)<1)return g(m).addClass("error"),g(m).html("Заполните поля правильно"),void g(m).append(g("<div>",{class:"errorDescription",text:"В строке "+(u?'"'+u+'"':s)+" количество заполнено неверно"}))}return 1}function s(){for(var t=0,e=g(h).find('[data-dynamic-row="true"]'),a=0;a<e.length;a++){var r,i,n=e[a],o=g(n).find(".serviceList")[0],d=g(o).select3("value").trim();""!==d&&void 0!==data.services[d]&&(r=g(n).find(".amount")[0],i=g(r).val(),t+=Number(i)*Number(data.services[d]))}return t}function r(t){if(0===t||void 0===t)return"";var e="",a=[];for(var r in data.tariffs)Object.prototype.hasOwnProperty.call(data.tariffs,r)&&data.tariffs[r]&&a.push(data.tariffs[r].name);for(var i=0;i<a.length;i++){var n=data.tariffs[i].hours;L(n)&&n<t&&(a[i]=null)}for(var o,d,s=Number.MAX_VALUE,l="",c=-1,u=0;u<a.length;u++){null===a[u]||(o=data.tariffs[u].hours)<s&&(s=o,c=u,l=data.tariffs[u].name)}return""===l?e+="Среди тарифов нет подходящего. Ваши потребности превышают лимиты самого дорогого тарифа":(e+="Вам походит тариф: ",e+=l,d=c,g(v).attr("data-tariffIndex",d),g(v).removeClass("d-none")),e}function i(){var t="",e=s();t+="Объем трудозатрат:",t+="&#160;&#160;&#160;",t+=function(t){var e=Math.floor(t),a=60*(t-e),r="";if(isNaN(e)||isNaN(a)||0===e&&0==a)r="0 часов";else{if(0!==e){if(r+=e+" ",10<e%100&&e%100<20)r+="часов";else switch(e%10){case 1:r+="час";break;case 2:case 3:case 4:r+="часа";break;default:r+="часов"}r+=" "}0!=a&&(r+=a+" минут")}return r}(e),g(m).html(t),g(m).append(g("<div>",{text:r(e),class:"tariff"}))}function C(t){g(v).addClass("d-none"),e.calculatorData=null,b(t)&&(i(),e.calculatorData=function(){for(var t={},e=g(h).find('[data-dynamic-row="true"]'),a=0;a<e.length;a++){var r=e[a],i=g(r).find(".serviceList")[0],n=g(i).select3("value"),o=g(r).find(".amount")[0],d=g(o).val();""!==n&&(t[n]=d)}return g.isEmptyObject(t)?null:(t["Оценка трудозатрат"]=s(),JSON.stringify(t))}())}function n(){if(b(!1)){p+=1;var t,e,a,r,i,n=(t=f.innerHTML,(e=document.createElement("div")).innerHTML=t.trim(),e.firstChild),o=g(n).find(".close")[0],d=g(n).find(".serviceList")[0],s=g(n).find(".amount")[0],l=g(n).find(".action")[0];for(var c in g(n).attr("data-dynamic-row","true"),g(n).attr("data-row-id",p),g(l).attr("data-row-id",p),g(d).attr("data-row-id",p),g(s).attr("data-row-id",p),g(o).attr("data-row-id",p),g(l).on("click",function(){var t=g(this).attr("data-row-id"),e=g(h).find('[data-dynamic-row="true"][data-row-id="'+t+'"]');g(e).find(".serviceList")[0].focus()}),data.services){Object.prototype.hasOwnProperty.call(data.services,c)&&((a=document.createElement("option")).value=c,a.innerHTML=c,d.appendChild(a))}g(d).select3({placeholderText:"Выберите услугу..."}),d=g(n).find(".serviceList")[0],g(d).on("select3ValueChanged",function(){y(),C(!1)}),g(o).on("click",function(){var t,e;1!==g(h).find('[data-dynamic-row="true"]').length&&(t=g(this).attr("data-row-id"),e=g(h).find('[data-dynamic-row="true"][data-row-id="'+t+'"]'),g(e).remove(),w(),C(!1))}),g(s).niceNumber({autoSize:!1,buttonPosition:"around",buttonDecrement:"−"}),r=s,i=function(t){return/^\d*$/.test(t)&&(""===t||1<=parseInt(t,10))},["input","keydown","keyup","mousedown","mouseup","select","contextmenu","drop"].forEach(function(t){r.addEventListener(t,function(){i(this.value)?(this.oldValue=this.value,this.oldSelectionStart=this.selectionStart,this.oldSelectionEnd=this.selectionEnd):this.hasOwnProperty("oldValue")&&(this.value=this.oldValue,this.setSelectionRange(this.oldSelectionStart,this.oldSelectionEnd))})}),g(s).on("focus",function(){g(this).parent().addClass("focused")}),g(s).on("blur",function(){g(this).parent().removeClass("focused")}),g(s).keydown(function(t){var e=g(this).val();if(L(e))switch(t.keyCode){case 37:case 38:g(this).val(Number(e)+1);break;case 39:case 40:g(this).val(Number(e)-1)}});var u=g(s).val();g(s).on("input",function(){u!==g(s).val()&&C(!1),u=g(s).val()}),h.appendChild(n),w(),y(),C(!0)}}g(v).on("click",function(){var t=g(this).attr("data-tariffIndex"),e=Number(t);g("#ModalCalculator").modal("hide"),g("#tariff").data("ionRangeSlider").update({from:e}),g("#ModalLong").modal("show")}),n(),g(a).click(n)}document.addEventListener("DOMContentLoaded",function(){globalThis.calculator=new t})}(jQuery);